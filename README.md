[![clasp](https://img.shields.io/badge/built%20with-clasp-4285f4.svg)](https://github.com/google/clasp)

# nhk-pg-watcher
NHK番組表を定期的にチェックするGoogle Apps Script.  
指定したキーワードを含む番組がヒットした場合は、メールに通知する。

## 動機
お気に入りの番組がBSかつ不定期で放映されている。
が、我が家のHDDレコーダーは、BSだとキーワード録画予約ができない。。

向こう１週間分の番組情報が提供されるNHK番組表APIに定期的に（1日1回）アクセスしよう！

## 準備
### NHK番組表APIのAPIキーを取得する。
https://api-portal.nhk.or.jp/ 

### パラメータの指定
下記パラメータをグローバルスコープに定義する。
ロジック本体のmain.jsとは別のjsファイルにしておく方が良さそう。バージョン管理対象と、機微情報の分離のため。

```js
// NHK番組表APIのページから取得したAPIキー
const APIKEY = 'xxxxxxxxxxxxx';

// NHKの放送エリアとチャンネル
const AREA = '000';
const SERVICE = 'tv'; // BSを含む全てのTVチャンネル

// タイトルに含まれているかチェックしたいキーワード
const KEYWORDS = ['サッカーの園', '魔改造の夜', '昆虫すごいぜ'];

// キーワードに該当する番組がヒットした際の通知先
const RECIPIENT = 'xxxxxxx@gmail.com';
```

NHKの放送エリアとチャンネルの値は、下記URLのAPIドキュメントで確認し、指定すること。  
https://api-portal.nhk.or.jp/doc-request

通知先は、Apps Scriptを登録するGoogleアカウント（gmailアドレス）しか指定できないかも？

### Apps Scriptを登録する
- Googleドライブ ＞ 新規 ＞ Google Apps Script
- main.jsやパラメータ用js（別ファイルにした場合）を登録する；貼り付ける、ないし、Apps Script開発用ツールの[clasp](https://github.com/google/clasp)を使ってアップロードする

### Apps Scriptのトリガーを設定する
定期的に実行するため、トリガーを設定する
- トリガー > トリガーの追加
- 1日1回、特定の時間帯に実行する場合は下記の通り設定（他の項目も適当に）
  - イベントのソースを選択：時間主導型
  - 時間ベースのトリガーのタイプを選択：日付ベースのタイマー
  - 時刻を選択：午前６時〜７時 ※GMT+09:00

## 実行例
キーワードにヒットした番組がある場合は、下記のようなメールが届く。

件名： `Target Programs were found!!`

本文：
```
キーワードを含む番組が見つかりました。

【2023-06-20】 3 items
- 01:25:00 [総合１] 魔改造の夜　名言集「ペンギンちゃん大縄跳び編」
- 02:30:00 [総合１] 魔改造の夜　名言集「お掃除ロボット走り幅跳び編」
- 00:55:00 [Ｅテレ１] 笑わない数学　確率論

【2023-06-21】 2 items
- 19:57:00 [総合１] 解体キングダム　想（おも）いのつまった建造物スペシャル
- 20:50:00 [ＢＳ１] デザイントークス＋「コンピュテーショナルデザイン」

【2023-06-23】 1 items
- 07:20:00 [Ｅテレ１] デザインあｎｅｏ　ガチャ

【2023-06-24】 3 items
- 00:25:00 [総合１] 魔改造の夜　鳩（はと）時計鳩（はと）入れ
- 21:30:00 [Ｅテレ１] 笑わない数学　🈡ガロア理論
- 18:10:00 [ＢＳ１] サッカーの園～究極のワンプレー～「移籍」

【2023-06-25】 1 items
- 22:55:00 [総合１] 魔改造の夜　名言集「ＤＶＤプレーヤーボウリング編」

【2023-06-26】 2 items
- 12:15:00 [Ｅテレ１] 趣味どきっ！　餃子（ぎょうざ）キングダム（３）「海を味方に」
- 21:30:00 [Ｅテレ１] 趣味どきっ！　餃子（ぎょうざ）キングダム（４）「無敵の皮はどれだ？」

【2023-06-27】 2 items
- 23:45:00 [総合１] 魔改造の夜　名言集「お掃除ロボット走り幅跳び編」
- 00:55:00 [Ｅテレ１] 笑わない数学　🈡ガロア理論

以上
```


## 参考
- [NHK番組表API](https://api-portal.nhk.or.jp/)
- [Qiita:NHK番組表APIの使い方](https://qiita.com/nkojima/items/88e5dd01a1401db8af7d)
- [Google Apps Script は何が強くてどんなときに使うべきか自分なりのプラクティスをまとめてみた](https://medium.com/google-cloud-jp/google-apps-script-%E3%81%AF%E4%BD%95%E3%81%8C%E5%BC%B7%E3%81%8F%E3%81%A6%E3%81%A9%E3%82%93%E3%81%AA%E3%81%A8%E3%81%8D%E3%81%AB%E4%BD%BF%E3%81%86%E3%81%B9%E3%81%8D%E3%81%8B%E8%87%AA%E5%88%86%E3%81%AA%E3%82%8A%E3%81%AE%E3%83%97%E3%83%A9%E3%82%AF%E3%83%86%E3%82%A3%E3%82%B9%E3%82%92%E3%81%BE%E3%81%A8%E3%82%81%E3%81%A6%E3%81%BF%E3%81%9F-248b3b0cfd20)
